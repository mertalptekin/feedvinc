
@{
    ViewBag.Title = "Feed";
    Layout = "~/Views/Shared/_SiteLayout.cshtml";
}

@{
    Html.RenderAction("GetNavbar", "HomeUI");
}

<main>
    <section class="container">
        <div class="row">
            <section class="col-lg-8 col-md-8 col-sm-12 col-xs-12">
                @Html.Partial("FeedPartial/_feedMenu")
                @Html.Partial("FeedPartial/_sharebox")

                @{
                    Html.RenderAction("GetFeedDefault", "HomeUI");
                }

            </section>
            <section class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
                <div class="row">
                    @Html.Partial("FeedPartial/_launch")
                    @Html.Partial("FeedPartial/_trend")
                    @Html.Partial("FeedPartial/_friendSuggest")
                    @Html.Partial("FeedPartial/_event")
                    @Html.Partial("FeedPartial/_community")
                </div>
            </section>
           <div id="scroll-loading"></div>
        </div>
    </section>
</main>

@section scripts{
    <script>
        toastr.options = {
            "closeButton": false,
            "debug": false,
            "newestOnTop": false,
            "progressBar": false,
            "positionClass": "toast-top-center"
        };

        var pageIndex = 0;

        $(window).scroll(function () {

            if ($(window).scrollTop() == $(document).height() - $(window).height()) {

                pageIndex++;
                alert("deneme");
 
                var id = sessionStorage.getItem("data-feed-id");

                if (sessionStorage.getItem("data-feed-id") == null)
                    id = 1;

                alert(id);
                var uri = "api/Feed/GetAroundMe?$expand=User:$filter=ShareTypeID eq " + id + ":$top=2:$skip=" + (pageIndex * 2);
                alert(uri);


                if (id == 1) {
                    var uri = "api/OData?$expand=User:$filter=ShareTypeID eq " + id + ":$top=2:$skip=" + (pageIndex * 2);
                    FeedScroll("/HomeUI/GetAroundMe?uri=", uri);
                }
            }
        })

        function FeedScroll(webUrl,apiUrl) {

            alert("test");

            $.ajax({
                url:webUrl + apiUrl,
                type: "Get",
                success: function (response) {
                    $("#feeds").append(response);
                },
                beforeSend: function () {
                    var target = document.getElementById('scroll-loading');
                    $(target).show();
                    var spinner = new Spinner().spin();
                    spinner.opts.position = "fixed";
                    spinner.opts.top = parseInt(opts.top.replace("%")) + pageIndex * $(window).height + "%";
                    spinner.opts.scale = 1;
                    spinner.spin();
                    target.appendChild(spinner.el);
                },
                complete: function () {
                    var target = document.getElementById('scroll-loading');
                    $(target).hide();
                }
            })
        }

        function MenuFilter(id) {

            var oldid = sessionStorage.getItem("data-feed-id");

            //önceki id şuanki tıklanandan farklı ise sayfalamayı 0'lar

            if (oldid != id)
                pageIndex = 0;

            //tıklanan menüyü session içinde saklıyoruz
            sessionStorage.setItem("data-feed-id", id);

            //menülerin class değişimi

            $(".feed-tag").removeClass("active");
            $(this).addClass("active");


            switch (id) {
                case 1:
                    var uri = "api/OData?$expand=User:$filter=ShareTypeID eq 1:$top=2";
                    FeedAjax("/HomeUI/GetAroundMe?uri=", uri);
                    break;
                case 2:
                    var uri = "api/OData?$expand=User:$filter=ShareTypeID eq 2";
                    //FeedAjax("/HomeUI/GetIdea?uri=", uri);
                    break;
                case 3:
                    var uri = "api/OData?$expand=User:$filter=ShareTypeID eq 3";
                    //FeedAjax("/HomeUI/GetStoryTelling?uri=", uri);
                    break;
                case 4:
                    var uri = "api/OData?$expand=User:$filter=ShareTypeID eq 4";
                    //FeedAjax("/HomeUI/GetFeedBack?uri=", uri);
                    break;
                case 5:
                    var uri = "api/OData?$expand=User:$filter=ShareTypeID eq 5";
                    //FeedAjax("/HomeUI/GetLaunch?uri=", uri);
                    break;

            }
        }

        function FeedAjax(webUrl, apiUrl) {
            $.ajax({
                url: webUrl + apiUrl,
                type: "Get",
                success: function (response) {
                    console.log(response);
                    var target = document.getElementById('loading');
                    $(target).hide();
                    $("#feeds").html(response);
                },
                beforeSend: function () {
                    var target = document.getElementById('loading');
                    $(target).show();
                    var spinner = new Spinner();
                    console.log(spinner.opts);
                    spinner.opts.top = "10%";
                    spinner.opts.scale = 2;
                    spinner.spin();
                    target.appendChild(spinner.el);
                }
            })
        }

        $('#frmShare').ajaxForm({
            clearForm: true,
            resetForm: true,
            beforeSubmit: function () {
                var target = document.getElementById('loading');
                $(target).show();
                var spinner = new Spinner();
                console.log(spinner.opts);
                spinner.opts.top = "10%";
                spinner.opts.scale = 2;
                spinner.spin();
                target.appendChild(spinner.el);
            },
            success: function (response) {
                console.log(response);
                var target = document.getElementById('loading');
                $(target).hide();

                $("#feeds").prepend(response);

                if (response.IsValid == false) {
                    toastr.error(response.ErrorMessage);
                    console.log(response);
                }
            }
        });
    </script>

}
